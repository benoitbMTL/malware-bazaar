import requests
import zipfile
import os
import pyzipper

# Function to get user input with defaults
def get_user_input():
    tag = input("Enter tag (default: 'TrickBot'): ") or "TrickBot"
    file_type = input("Enter file type (default: 'elf'): ") or "elf"
    limit = input("Enter limit (default: 50): ") or "50"
    return tag, file_type, limit

# Function to fetch hashes from MalwareBazaar
def fetch_hashes(tag, file_type, limit):
    print(f"Fetching hashes for tag: {tag}, file type: {file_type}, limit: {limit}")
    url = "https://mb-api.abuse.ch/api/v1/"
    post_data = {
        "query": "get_file_type",
        "file_type": file_type,
        "limit": limit
    }
    response = requests.post(url, data=post_data)
    hashes = [(item['sha256_hash'], item['tags']) for item in response.json()['data']]
    return hashes

# Function to download and unzip files
def download_and_unzip(hashes):
    downloaded_files = []
    for hash_val, tags in hashes:
        print(f"\nDownloading file with SHA256 hash: {hash_val}")
        print(f"Tags: {tags}")

        # Download the file
        post_data = {
            "query": "get_file",
            "sha256_hash": hash_val
        }
        response = requests.post("https://mb-api.abuse.ch/api/v1/", data=post_data)
        
        # Save the zip file
        zip_filename = hash_val + ".zip"
        with open(zip_filename, 'wb') as file:
            file.write(response.content)
        print("Download complete. Unzipping file...")

        # Unzip the file
        try:
            with pyzipper.AESZipFile(zip_filename) as zf:
                zf.pwd = b'infected'
                zf.extractall("unzipped_files")
            print("Unzipping complete.")
            downloaded_files.append(zip_filename.replace('.zip', ''))
        except Exception as e:
            print(f"Error unzipping file: {e}")

        # Remove the zip file
        os.remove(zip_filename)
        print("Zip file removed.")

    return downloaded_files

# Main function
def main():
    tag, file_type, limit = get_user_input()
    hashes = fetch_hashes(tag, file_type, limit)
    downloaded_files = download_and_unzip(hashes)
    print("\nDownloaded and unzipped the following files:")
    for file in downloaded_files:
        print(file)

if __name__ == "__main__":
    main()
